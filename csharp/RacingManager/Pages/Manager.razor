@page "/racing"
@inject HttpClient Http

<PageTitle>Racing Manager</PageTitle>

<h1>Racing Manager</h1>

<div class="section">
    <div class="inline-form">
        <input type="text" @bind-value="_raceName" class="form-control" placeholder="Race name" />
        <button class="btn btn-primary" @onclick="AddRace">Add Race</button>
    </div>
</div>

<div class="section">
    <div class="inline-form">
        <input type="text" @bind-value="_racerName" class="form-control" placeholder="Racer name">
        <div class="form-check">
            <input type="checkbox" id="isAI" @bind="_isAI" class="form-check-input">
            <label for="isAI" class="form-check-label">Is AI</label>
        </div>
        <button class="btn btn-primary" @onclick="AddRacer">Add Racer</button>
    </div>
</div>

<div class="section">
    <div class="inline-form">
        <select @bind="@_selectedRaceId" class="form-select">
            @foreach (var kvp in _racingSeason.GetRaces())
            {
                <option value="@kvp.Key">@kvp.Value</option>
            }
        </select>
        <select @bind="@_selectedRacerId" class="form-select">
            @foreach (var kvp in _racingSeason.GetRacers())
            {
                <option value="@kvp.Key">@kvp.Value</option>
            }
        </select>
        <select @bind="@_selectedPosition" class="form-select" style="width: auto;">
            @for (int i = 1; i <= _racingSeason.GetRacers().Count; i++)
            {
                <option value="@i">@i</option>
            }
        </select>
        <button class="btn btn-primary" @onclick="AddPosition">Add Result</button>
    </div>
</div>

<div class="section">
    <h3>Results</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Racer</th>
                <th>Points</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var kvp in _racingSeason.GetResults())
            {
                <tr>
                    <td>@kvp.Key.racerName</td>
                    <td><span title="@GetRacerResultsTitle(kvp.Key.racerId)">@kvp.Value</span></td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    private RacingSeason _racingSeason = new RacingSeason();

    private string _raceName = "";
    private void AddRace()
    {
        _racingSeason.AddRace(_raceName);
        _raceName = "";
    }

    private string _racerName = "";
    private bool _isAI = false;
    private void AddRacer()
    {
        _racingSeason.AddRacer(_racerName, _isAI);
        _racerName = "";
        _isAI = false;
    }

    private Guid _selectedRaceId;
    private Guid _selectedRacerId;
    private int _selectedPosition;
    private void AddPosition()
    {
        if (_selectedRaceId == Guid.Empty)
        {
            _selectedRaceId = _racingSeason.GetRaces().First().Key;
        }

        if (_selectedRacerId == Guid.Empty)
        {
            _selectedRacerId = _racingSeason.GetRacers().First().Key;
        }

        if (_selectedPosition == 0)
        {
            _selectedPosition = 1;
        }

        _racingSeason.AddResult(_selectedRaceId, _selectedRacerId, _selectedPosition);
    }

    private string GetRacerResultsTitle(Guid racerId)
    {
        return string.Join("\n", _racingSeason.GetRacerPositions(racerId).Select(r => $"{r.raceName}: {r.position}"));
    }
}
